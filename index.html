const SHEET_NAME_DATA = "DATA";
const SHEET_NAME_MOVES = "2026";
const SHEET_NAME_BALANCE = "BALANCE";

function doGet(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // 1. Λίστες Κατηγοριών & Τραπεζών
  const dataSheet = ss.getSheetByName(SHEET_NAME_DATA);
  const categories = dataSheet.getRange(2, 1, dataSheet.getLastRow() - 1, 1).getValues().flat().filter(String);
  let banks = [];
  try { banks = dataSheet.getRange(2, 3, dataSheet.getLastRow() - 1, 1).getValues().flat().filter(String); } catch (err) {}
  if (banks.length === 0) banks = ["Μετρητά", "Πειραιώς", "Eurobank", "Alpha", "Εθνική", "IRIS", "Κάρτα"];

  // 2. Στατιστικά Εσόδων/Εξόδων (2026)
  let stats = { month: { income: 0, expense: 0 }, year: { income: 0, expense: 0 } };
  try {
    const movesSheet = ss.getSheetByName(SHEET_NAME_MOVES);
    if (movesSheet && movesSheet.getLastRow() > 1) {
      const data = movesSheet.getRange(2, 1, movesSheet.getLastRow() - 1, 6).getValues();
      const now = new Date();
      data.forEach(row => {
        const rowDate = new Date(row[0]);
        const amount = Number(row[2]) || 0;
        const type = row[5];
        if (!isNaN(rowDate.getTime()) && rowDate.getFullYear() === now.getFullYear()) {
          if (type === "Έσοδο") stats.year.income += amount;
          if (type === "Έξοδο") stats.year.expense += amount;
          if (rowDate.getMonth() === now.getMonth()) {
            if (type === "Έσοδο") stats.month.income += amount;
            if (type === "Έξοδο") stats.month.expense += amount;
          }
        }
      });
    }
  } catch (e) {}

  // 3. Δεδομένα BALANCE για το γράφημα κατανομής
  let balanceData = { labels: [], values: [], total: 0 };
  try {
    const balSheet = ss.getSheetByName(SHEET_NAME_BALANCE);
    const now = new Date();
    const monthCol = now.getMonth() + 3; // Στήλη C=3, D=4...
    const names = balSheet.getRange(2, 1, 16, 1).getValues().flat();
    const amounts = balSheet.getRange(2, monthCol, 16, 1).getValues().flat();
    
    names.forEach((name, i) => {
      const val = Number(amounts[i]) || 0;
      if (val > 0) {
        balanceData.labels.push(name);
        balanceData.values.push(val);
        balanceData.total += val;
      }
    });
  } catch (e) {}

  return ContentService.createTextOutput(JSON.stringify({categories, banks, stats, balanceData}))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    if (data.action === "updateBalance") {
      const sheet = ss.getSheetByName(SHEET_NAME_BALANCE);
      const monthCol = parseInt(data.monthIndex) + 3; 
      const valuesArray = data.values.map(v => [v]);
      sheet.getRange(2, monthCol, 16, 1).setValues(valuesArray);
      const colLetter = String.fromCharCode(64 + monthCol);
      sheet.getRange(18, monthCol).setFormula(`=SUM(${colLetter}2:${colLetter}17)`);
      return ContentService.createTextOutput(JSON.stringify({status: "success"})).setMimeType(ContentService.MimeType.JSON);
    }
    
    const sheet = ss.getSheetByName(SHEET_NAME_MOVES);
    const dateObj = new Date(data.date);
    const monthNames = ["ΙΑΝΟΥΑΡΙΟΣ", "ΦΕΒΡΟΥΑΡΙΟΣ", "ΜΑΡΤΙΟΣ", "ΑΠΡΙΛΙΟΣ", "ΜΑΪΟΣ", "ΙΟΥΝΙΟΣ", "ΙΟΥΛΙΟΣ", "ΑΥΓΟΥΣΤΟΣ", "ΣΕΠΤΕΜΒΡΙΟΣ", "ΟΚΤΩΒΡΙΟΣ", "ΝΟΕΜΒΡΙΟΣ", "ΔΕΚΕΜΒΡΙΟΣ"];
    sheet.appendRow([Utilities.formatDate(dateObj, Session.getScriptTimeZone(), "yyyy-MM-dd"), monthNames[dateObj.getMonth()], data.amount, data.category, data.bank, data.type]);
    return ContentService.createTextOutput(JSON.stringify({status: "success"})).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({status: "error", message: error.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}
